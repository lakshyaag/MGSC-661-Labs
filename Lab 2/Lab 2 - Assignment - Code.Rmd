---
title: "MGSC 661-075 - Lab 2"
output: html_notebook
author: "Lakshya Agarwal, Jatin Suri"
---

# Lab 2

```{r}
require(visreg)
require(glue)
require(car)
require(lmtest)
require(splines)
require(psych)
require(stargazer)
require(plm)
require(ggplot2)
require(ggpubr)
```

## Importing data

```{r}
data <- read.csv("./board_games_fall_2023.csv")
attach(data)
head(data)
```

## 1. Model Issues: Non-linearity

#### `avg_rating = bo+ b1(year)+ b2(avg_timeplay)+ b3(weight)`

#### Part A:

```{r}
reg1 <- lm(avg_rating ~ year + avg_timeplay + weight)
residualPlots(reg1)
```

## 2. Model Issues: Heteroskedasticity

#### `avg_rating = bo+ b1(avg_timeplay)`

#### Part B:

```{r}
reg2 <- lm(avg_rating ~ avg_timeplay)
summary(reg2)
```

#### Part C:

```{r}
residualPlot(reg2, quadratic = FALSE)
```

#### Part D:

```{r}
ncvTest(reg2)
```

#### Part E:

```{r}
coeftest(reg2, vcov = vcovHC(reg2, type = "HC1"))
```

## 3. Model Issues: Outliers

#### `avg_rating = bo+ b1(min_players)+ b2(age)+ b3(num_votes)`

#### Part A:

```{r}
reg3 <- lm(avg_rating ~ min_players + age + num_votes)
summary(reg3)
qqPlot(reg3, envelope = FALSE)
outlierTest(reg3)
```

#### Part B:

```{r}
data[3124, ]
```

#### Part C:

```{r}
new_data <- data[-c(3124), ]

reg4 <- lm(data = new_data, formula = avg_rating ~ min_players + age + num_votes)
summary(reg4)
```

## 4. Model Issues: Collinearity

#### `avg_rating = bo+ b1(year)+ b2(age)+ b3(min_timeplay)+ b4(max_timeplay)`

#### Part B:

```{r}
quantvars <- data[, c(7, 8, 9, 12)]
corr_matrix <- cor(quantvars)
round(corr_matrix, 2)
```

#### Part D:

```{r}
reg5 <- lm(avg_rating ~ year + age + min_timeplay + max_timeplay)
summary(reg5)
vif(reg5)
```

#### Part F:
```{r}
reg5_1 <- lm(avg_rating ~ year + age + min_timeplay)
summary(reg5_1)
vif(reg5_1)
```


## 5. Presenting professional regression tables

#### Models
`reg1: avg_rating = bo+ b1(avg_timeplay)`

`reg2: avg_rating = bo+ b2(min_players)`

`reg3: avg_rating = bo+ b3(max_players)`

`mreg: avg_rating = bo+ b1(avg_timeplay)+ b2(min_players)+ b3(max_players)`

#### Part A:

```{r}
reg1 <- lm(avg_rating ~ avg_timeplay)
reg2 <- lm(avg_rating ~ min_players)
reg3 <- lm(avg_rating ~ max_players)
mreg <- lm(avg_rating ~ avg_timeplay + min_players + max_players)
stargazer(reg1, reg2, reg3, mreg, type = "html")
```

#### Part B:

```{r}
summary(reg2)
```

#### Part C:

```{r}
stargazer(reg1, reg2, reg3, mreg, 
          title = "Regression Results", 
          type = "html", 
          align = TRUE, 
          dep.var.labels = c("Board Game Rating"), 
          covariate.labels = c("Average timeplay", "Minimum number of players", "Maximum number of players"))
```

#### Part D:

```{r}
stargazer(reg1, reg2, reg3, mreg, 
          title = "Regression Results", 
          type = "html", 
          align = TRUE, 
          dep.var.labels = c("Board Game Rating"), 
          covariate.labels = c("Average timeplay", "Minimum number of players", "Maximum number of players"),
          digits = 2)
```
## 6. Polynomial regression: Age

`avg_rating = f(age)`

#### Part A:
```{r}
poly_reg_1 <- lm(avg_rating ~ poly(age, degree = 1))
poly_reg_2 <- lm(avg_rating ~ poly(age, degree = 2))
poly_reg_3 <- lm(avg_rating ~ poly(age, degree = 3))
poly_reg_4 <- lm(avg_rating ~ poly(age, degree = 4))

names(poly_reg_1$coefficients) <- c("Constant", "Age")
names(poly_reg_2$coefficients) <- c("Constant", "Age", "Age^2")
names(poly_reg_3$coefficients) <- c("Constant", "Age", "Age^2", "Age^3")
names(poly_reg_4$coefficients) <- c("Constant", "Age", "Age^2", "Age^3", "Age^4")

stargazer(poly_reg_1, poly_reg_2, poly_reg_3, poly_reg_4,
          title = "Regression Results", 
          type = "html", 
          align = TRUE, 
          dep.var.labels = c("Board Game Rating"), 
          covariate.labels = c("Constant", "Age", "Age<sup>2</sup>", "Age<sup>3</sup>", "Age<sup>4</sup>"),
          column.labels = c("d=1", "d=2", "d=3", "d=4"),
          digits = 2)
```
#### Part B:
```{r}
plot_dn <- function(data, n) {
  plot <- ggplot(data, aes(x = age, y=avg_rating)) +
    geom_point(color="grey") +
    geom_smooth(method = "lm", formula = y ~ poly(x, n), aes(colour=glue("Degree {n}")), se=FALSE) +
    labs(x = "Age", y = "Average rating", title = glue("Polynomial regression (d={n})"), caption = "Source: Board Game Data") +
    scale_color_manual(name = "Degree of Fit", values = c("blue")) +
    theme_classic()
          
  return(plot)
}

plot_d1 <- plot_dn(data, 1)
plot_d2 <- plot_dn(data, 2)
plot_d3 <- plot_dn(data, 3)
plot_d4 <- plot_dn(data, 4)

ggarrange(plot_d1, plot_d2, plot_d3, plot_d4, nrow = 2, ncol = 2, legend = "top", labels = "AUTO")

```

#### Part C:
```{r}
anova(poly_reg_1, poly_reg_2, poly_reg_3, poly_reg_4)
```

## 7. Polynomial regression: avg_timeplay

`avg_rating = f(avg_timeplay)`

#### Part A:
```{r}
poly_reg_1 <- lm(avg_rating ~ poly(avg_timeplay, degree = 1))
poly_reg_2 <- lm(avg_rating ~ poly(avg_timeplay, degree = 2))
poly_reg_3 <- lm(avg_rating ~ poly(avg_timeplay, degree = 3))
poly_reg_4 <- lm(avg_rating ~ poly(avg_timeplay, degree = 4))

names(poly_reg_1$coefficients) <- c("Constant", "X")
names(poly_reg_2$coefficients) <- c("Constant", "X", "X^2")
names(poly_reg_3$coefficients) <- c("Constant", "X", "X^2", "X^3")
names(poly_reg_4$coefficients) <- c("Constant", "X", "X^2", "X^3", "X^4")


stargazer(poly_reg_1, poly_reg_2, poly_reg_3, poly_reg_4,
          title = "Regression Results (avg\\_rating ~ avg\\_timeplay)", 
          type = "html", 
          align = TRUE, 
          dep.var.labels = c("Board Game Rating"), 
          covariate.labels = c("Constant", "x", "x<sup>2</sup>", "x<sup>3</sup>", "x<sup>4</sup>"),
          column.labels = c("d=1", "d=2", "d=3", "d=4"),
          digits = 2)
```

#### Part B:
```{r, fig.width=5, fig.height=7}
plot_dn <- function(data, n) {
  plot <- ggplot(data, aes(x = avg_timeplay, y=avg_rating)) +
    geom_point(color="grey") +
    geom_smooth(method = "lm", formula = y ~ poly(x, n), aes(colour=glue("Degree {n}")), se=FALSE) +
    labs(x = "Average Timeplay", y = "Average rating", title = glue("Polynomial regression (d={n})"), caption = "Source: Board Game Data") +
    scale_color_manual(name = "Degree of Fit", values = c("green")) +
    theme_classic()
          
  return(plot)
}

plot_d1 <- plot_dn(data, 1)
plot_d2 <- plot_dn(data, 2)
plot_d3 <- plot_dn(data, 3)
plot_d4 <- plot_dn(data, 4)

ggarrange(plot_d1, plot_d2, plot_d3, plot_d4, nrow = 4, ncol = 1, legend = "right")
```

#### Part C:
```{r}
anova(poly_reg_1, poly_reg_2, poly_reg_3, poly_reg_4)
```

## 8. Multiple polynomial regression 

`avg_rating = f(age, avg_timeplay)`

#### Part A:
```{r}
poly_reg_final <- lm(avg_rating ~ poly(avg_timeplay, 1) + poly(age, 3))
summary(poly_reg_final)
```

#### Part B:
```{r}
stargazer(poly_reg_final,
          title = "Regression Results", 
          type = "html", 
          align = TRUE, 
          dep.var.labels = c("Board Game Rating"), 
          covariate.labels = c("Constant", "Average Timeplay", "Age", "Age<sup>2</sup>", "Age<sup>3</sup>"),
          digits = 2)

```

## 9. Spline regression

`avg_rating = f(avg_timeplay)`

#### Part B:
```{r}
knots = quantile(avg_timeplay)
spline_reg_1 <- lm(avg_rating ~ bs(avg_timeplay, knots = knots, degree = 1))
spline_reg_2 <- lm(avg_rating ~ bs(avg_timeplay, knots = knots, degree = 2))
spline_reg_3 <- lm(avg_rating ~ bs(avg_timeplay, knots = knots, degree = 3))


stargazer(spline_reg_1, spline_reg_2, spline_reg_3,
          title = "Spline Regression Results (avg\\_rating ~ avg\\_timeplay)", 
          type = "html", 
          align = TRUE, 
          dep.var.labels = c("Board Game Rating"),
          column.labels = c("d=1", "d=2", "d=3"),
          digits = 2)
```

#### Part C:
```{r, fig.width=10, fig.height=7}
plot_spline_n <- function(data, n) {
  knots = quantile(avg_timeplay)
  
  plot <- ggplot(data, aes(x = avg_timeplay, y = avg_rating)) +
  geom_point(color = "grey") +
  geom_smooth(
    method = "lm",
    formula = y ~ bs(x, knots = knots, degree = n),
    se = FALSE,
    aes(color = glue("Degree {n} - 3 knots"))
  ) + 
  geom_vline(xintercept = knots, linetype="dotted") +
  labs(x = "Average Timeplay", y = "Average Rating", title = glue("Spline regression (d={n})"), caption = "Source: Board Game Data") +
    scale_color_manual(name = "Degree of Fit", values = c("red")) +
    theme_classic()
  
  return(plot)
}

ggarrange(plot_spline_n(data, 1), plot_spline_n(data, 2), plot_spline_n(data, 3), ncol = 3, legend = "top")
```

